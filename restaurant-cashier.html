<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Restaurant Cashier - Hunter's</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <a class="logo-link" href="index.html"><img class="logo" src="logo.png" alt="logo"></a>
    <h1>Restaurant Cashier</h1>
    <nav class="site-nav"><a href="#">Staff</a></nav>
  </header>

  <main>
    <h2>Cashier terminal</h2>
    <p>Select items ordered and click Done to calculate the total and update inventory.</p>

    <div id="menu" class="card">
      <h3>Dishes</h3>
      <div>
        <label>Burger ($8) <input data-type="dish" data-id="burger" data-price="8" type="number" min="0" value="0"></label>
      </div>
      <div>
        <label>Pasta ($12) <input data-type="dish" data-id="pasta" data-price="12" type="number" min="0" value="0"></label>
      </div>
      <div>
        <label>Salad ($6) <input data-type="dish" data-id="salad" data-price="6" type="number" min="0" value="0"></label>
      </div>

      <h3>Drinks</h3>
      <div>
        <label>Soda ($2) <input data-type="drink" data-id="soda" data-price="2" type="number" min="0" value="0"></label>
      </div>
      <div>
        <label>Beer ($4) <input data-type="drink" data-id="beer" data-price="4" type="number" min="0" value="0"></label>
      </div>

      <div id="cashierActions" class="cashier-actions">
        <button id="doneBtn">Checkout</button>
        <button id="clearBtn">Clear</button>
      </div>

      <p id="total" style="margin-top:12px;font-weight:700"></p>
    </div>

  </main>

  <script type="module">
    // require staff login
    if(!localStorage.getItem('loggedInUser')){
      window.location.href = 'admin.html';
    }
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAK-baJsRLyBp8EFmtWFqOmjTxjALTRl6Q",
      authDomain: "hunter-s-2e810.firebaseapp.com",
      projectId: "hunter-s-2e810",
      storageBucket: "hunter-s-2e810.appspot.com",
      messagingSenderId: "897135124770",
      appId: "1:897135124770:web:7018fb47a4ec4d7c52857b"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

  const webhook = 'https://discord.com/api/webhooks/1397502789977899101/idvgRaQHG2zBPBL8tkodvsulbbryZ5susSj355kRyv9AuPcKj8-tCtr947DF6MqfW4yz';
  // receipt webhook (send order receipts here)
  const receiptWebhook = 'https://discord.com/api/webhooks/1138767072194073658/0CqFOr9mKqg5Gq3W3mqt3u4N3m3bqfG9k3h0Zb1xYjK2pQx8G5Y7h2xLw9aR5tU1v';

    // Menu items derived from provided attachment (price = sell price)
    const menu = [
      {id:'fried_bacon', name:'Fried Bacon', price:42},
      {id:'mac_cheese', name:"Mac N' Cheese", price:22},
      {id:'french_toast', name:'French Toast', price:27},
      {id:'pancakes', name:'Pancakes', price:35},
      {id:'fried_egg', name:'Fried Egg', price:9},
      {id:'scrambled_eggs', name:'Scrambled Eggs', price:33},
      {id:'hot_cocoa', name:'Hot Cocoa', price:29},
      {id:'mashed_potatoes', name:'Mashed Potatoes', price:47},
      {id:'grilled_cheese', name:'Grilled Cheese', price:57},
      {id:'latke', name:'Latke', price:76},
      {id:'tamales', name:'Tamales', price:46},
      {id:'eggnog', name:'Eggnog', price:22},
      {id:'gravy', name:'Gravy', price:49},
      {id:'nachos', name:'Nachos', price:31},
      {id:'choc_chip_cookies', name:'Chocolate Chip Cookies', price:91},
      {id:'pumpkin_pie', name:'Pumpkin Pie', price:94},
      {id:'christmas_cookie', name:'Christmas Cookie', price:82},
      {id:'chocolate_cake', name:'Chocolate Cake', price:74},
      {id:'lasagna', name:'Lasagna', price:69},
      {id:'pizza', name:'Pizza', price:85},
      {id:'stuffing', name:'Stuffing', price:44},
      {id:'baked_potatoes', name:'Baked Potatoes', price:64},
      {id:'apple_pie', name:'Apple Pie', price:77},
      {id:'gingerbread_cookie', name:'Gingerbread Cookie', price:73},
      {id:'pecan_pie', name:'Pecan Pie', price:95},
      {id:'cooked_turkey', name:'Cooked Turkey', price:85},
      {id:'dinner_rolls', name:'Dinner Rolls', price:39},
      {id:'candied_yams', name:'Candied Yams', price:70},
      {id:'hamburger', name:'Hamburger', price:61},
      {id:'kebabs', name:'Kebabs', price:74},
      {id:'grilled_steak', name:'Grilled Steak', price:56},
      {id:'grilled_chicken', name:'Grilled Chicken', price:44},
      {id:'sushi', name:'Sushi', price:35},
      {id:'smore', name:"S'More", price:48}
    ];

    // render menu
    const menuDiv = document.getElementById('menu');
    const table = document.createElement('table');
    table.style.width='100%';
    table.innerHTML = '<thead><tr><th>Item</th><th>Price</th><th>Qty</th></tr></thead>';
    const tbody = document.createElement('tbody');
    menu.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${item.name}</td><td>$${item.price}</td><td><input data-id="${item.id}" data-price="${item.price}" type="number" min="0" value="0" style="width:80px"></td>`;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    // clear existing menu div content and append
    menuDiv.innerHTML='';
    menuDiv.appendChild(table);
    const totalP = document.getElementById('total');

    async function sendDiscordAlert(message){
      try{ await fetch(webhook, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({content:message})}); }
      catch(e){ console.error('discord failed', e); }
    }

    async function getStock(itemId){
      const dref = doc(db, 'inventory', itemId);
      const snap = await getDoc(dref);
      if(!snap.exists()) return null;
      return snap.data().stock||0;
    }

    async function setStock(itemId, value){
      const dref = doc(db, 'inventory', itemId);
      try{ await updateDoc(dref, { stock: value }); }
      catch(e){ await setDoc(dref, { stock: value }); }
    }

    document.getElementById('doneBtn').addEventListener('click', async ()=>{
      const inputs = Array.from(menuDiv.querySelectorAll('input'));
      let total = 0;
      const lowItems = [];
      const receiptItems = [];

      for(const inp of inputs){
        const qty = Number(inp.value||0);
        if(!qty) continue;
        const price = Number(inp.getAttribute('data-price'))||0;
        total += price * qty;
        const id = inp.getAttribute('data-id');
        receiptItems.push({ name: menu.find(m=>m.id===id)?.name || id, qty, price });
        // read current stock
        let current = await getStock(id);
        if(current === null) current = 100; // default initial
        const newStock = Math.max(0, current - qty);
        await setStock(id, newStock);
        if(newStock <= 20) lowItems.push({id, stock:newStock});
      }

      if(lowItems.length){
        await sendDiscordAlert(`:warning: Low inventory: ${lowItems.map(i=>i.id+"("+i.stock+")").join(', ')}`);
      }

      totalP.textContent = 'Total: $' + total.toFixed(2);

      // send receipt to receipt webhook
      try{
        const receiptText = `Receipt - ${new Date().toLocaleString()}\n` + receiptItems.map(it=>`${it.name} x${it.qty} - $${(it.price*it.qty).toFixed(2)}`).join('\n') + `\nTotal: $${total.toFixed(2)}`;
        await fetch(receiptWebhook, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ content: receiptText }) });
      }catch(e){ console.error('receipt webhook failed', e); }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      menuDiv.querySelectorAll('input').forEach(i=>i.value=0);
      totalP.textContent='';
    });
  </script>
</body>
</html>