<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Restaurant Cashier - Hunter's</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <a class="logo-link" href="index.html"><img class="logo" src="logo.png" alt="logo"></a>
    <h1>Restaurant Cashier</h1>
    <nav class="site-nav"><a href="admin.html">Staff</a></nav>
  </header>

  <main>
    <div class="card" id="cashierCard">
      <h2>Cashier terminal</h2>
      <p class="muted">Select items and enter quantities. Click <strong>Checkout</strong> to finalize and update inventory.</p>

      <div id="menuContainer" style="overflow:auto;max-height:620px">
        <table id="menuTable" aria-label="Menu items">
          <thead>
            <tr><th style="width:60%">Item</th><th style="width:20%">Price</th><th style="width:20%">Qty</th></tr>
          </thead>
          <tbody>
            <tr><td style="color:#fff">Fried Bacon</td><td style="color:#fff">$42</td><td><input class="qty" data-id="fried_bacon" data-price="42" type="number" min="0" value="0" aria-label="Fried Bacon quantity"></td></tr>
            <tr><td style="color:#fff">Mac N' Cheese</td><td style="color:#fff">$22</td><td><input class="qty" data-id="mac_cheese" data-price="22" type="number" min="0" value="0" aria-label="Mac N' Cheese quantity"></td></tr>
            <tr><td style="color:#fff">French Toast</td><td style="color:#fff">$27</td><td><input class="qty" data-id="french_toast" data-price="27" type="number" min="0" value="0" aria-label="French Toast quantity"></td></tr>
            <tr><td style="color:#fff">Pancakes</td><td style="color:#fff">$35</td><td><input class="qty" data-id="pancakes" data-price="35" type="number" min="0" value="0" aria-label="Pancakes quantity"></td></tr>
            <tr><td style="color:#fff">Fried Egg</td><td style="color:#fff">$9</td><td><input class="qty" data-id="fried_egg" data-price="9" type="number" min="0" value="0" aria-label="Fried Egg quantity"></td></tr>
            <tr><td style="color:#fff">Scrambled Eggs</td><td style="color:#fff">$33</td><td><input class="qty" data-id="scrambled_eggs" data-price="33" type="number" min="0" value="0" aria-label="Scrambled Eggs quantity"></td></tr>
            <tr><td style="color:#fff">Hot Cocoa</td><td style="color:#fff">$29</td><td><input class="qty" data-id="hot_cocoa" data-price="29" type="number" min="0" value="0" aria-label="Hot Cocoa quantity"></td></tr>
            <tr><td style="color:#fff">Mashed Potatoes</td><td style="color:#fff">$47</td><td><input class="qty" data-id="mashed_potatoes" data-price="47" type="number" min="0" value="0" aria-label="Mashed Potatoes quantity"></td></tr>
            <tr><td style="color:#fff">Grilled Cheese</td><td style="color:#fff">$57</td><td><input class="qty" data-id="grilled_cheese" data-price="57" type="number" min="0" value="0" aria-label="Grilled Cheese quantity"></td></tr>
            <tr><td style="color:#fff">Latke</td><td style="color:#fff">$76</td><td><input class="qty" data-id="latke" data-price="76" type="number" min="0" value="0" aria-label="Latke quantity"></td></tr>
            <tr><td style="color:#fff">Tamales</td><td style="color:#fff">$46</td><td><input class="qty" data-id="tamales" data-price="46" type="number" min="0" value="0" aria-label="Tamales quantity"></td></tr>
            <tr><td style="color:#fff">Eggnog</td><td style="color:#fff">$22</td><td><input class="qty" data-id="eggnog" data-price="22" type="number" min="0" value="0" aria-label="Eggnog quantity"></td></tr>
            <tr><td style="color:#fff">Gravy</td><td style="color:#fff">$49</td><td><input class="qty" data-id="gravy" data-price="49" type="number" min="0" value="0" aria-label="Gravy quantity"></td></tr>
            <tr><td style="color:#fff">Nachos</td><td style="color:#fff">$31</td><td><input class="qty" data-id="nachos" data-price="31" type="number" min="0" value="0" aria-label="Nachos quantity"></td></tr>
            <tr><td style="color:#fff">Chocolate Chip Cookies</td><td style="color:#fff">$91</td><td><input class="qty" data-id="choc_chip_cookies" data-price="91" type="number" min="0" value="0" aria-label="Chocolate Chip Cookies quantity"></td></tr>
            <tr><td style="color:#fff">Pumpkin Pie</td><td style="color:#fff">$94</td><td><input class="qty" data-id="pumpkin_pie" data-price="94" type="number" min="0" value="0" aria-label="Pumpkin Pie quantity"></td></tr>
            <tr><td style="color:#fff">Christmas Cookie</td><td style="color:#fff">$82</td><td><input class="qty" data-id="christmas_cookie" data-price="82" type="number" min="0" value="0" aria-label="Christmas Cookie quantity"></td></tr>
            <tr><td style="color:#fff">Chocolate Cake</td><td style="color:#fff">$74</td><td><input class="qty" data-id="chocolate_cake" data-price="74" type="number" min="0" value="0" aria-label="Chocolate Cake quantity"></td></tr>
            <tr><td style="color:#fff">Lasagna</td><td style="color:#fff">$69</td><td><input class="qty" data-id="lasagna" data-price="69" type="number" min="0" value="0" aria-label="Lasagna quantity"></td></tr>
            <tr><td style="color:#fff">Pizza</td><td style="color:#fff">$85</td><td><input class="qty" data-id="pizza" data-price="85" type="number" min="0" value="0" aria-label="Pizza quantity"></td></tr>
            <tr><td style="color:#fff">Stuffing</td><td style="color:#fff">$44</td><td><input class="qty" data-id="stuffing" data-price="44" type="number" min="0" value="0" aria-label="Stuffing quantity"></td></tr>
            <tr><td style="color:#fff">Baked Potatoes</td><td style="color:#fff">$64</td><td><input class="qty" data-id="baked_potatoes" data-price="64" type="number" min="0" value="0" aria-label="Baked Potatoes quantity"></td></tr>
            <tr><td style="color:#fff">Apple Pie</td><td style="color:#fff">$77</td><td><input class="qty" data-id="apple_pie" data-price="77" type="number" min="0" value="0" aria-label="Apple Pie quantity"></td></tr>
            <tr><td style="color:#fff">Gingerbread Cookie</td><td style="color:#fff">$73</td><td><input class="qty" data-id="gingerbread_cookie" data-price="73" type="number" min="0" value="0" aria-label="Gingerbread Cookie quantity"></td></tr>
            <tr><td style="color:#fff">Pecan Pie</td><td style="color:#fff">$95</td><td><input class="qty" data-id="pecan_pie" data-price="95" type="number" min="0" value="0" aria-label="Pecan Pie quantity"></td></tr>
            <tr><td style="color:#fff">Cooked Turkey</td><td style="color:#fff">$85</td><td><input class="qty" data-id="cooked_turkey" data-price="85" type="number" min="0" value="0" aria-label="Cooked Turkey quantity"></td></tr>
            <tr><td style="color:#fff">Dinner Rolls</td><td style="color:#fff">$39</td><td><input class="qty" data-id="dinner_rolls" data-price="39" type="number" min="0" value="0" aria-label="Dinner Rolls quantity"></td></tr>
            <tr><td style="color:#fff">Candied Yams</td><td style="color:#fff">$70</td><td><input class="qty" data-id="candied_yams" data-price="70" type="number" min="0" value="0" aria-label="Candied Yams quantity"></td></tr>
            <tr><td style="color:#fff">Hamburger</td><td style="color:#fff">$61</td><td><input class="qty" data-id="hamburger" data-price="61" type="number" min="0" value="0" aria-label="Hamburger quantity"></td></tr>
            <tr><td style="color:#fff">Kebabs</td><td style="color:#fff">$74</td><td><input class="qty" data-id="kebabs" data-price="74" type="number" min="0" value="0" aria-label="Kebabs quantity"></td></tr>
            <tr><td style="color:#fff">Grilled Steak</td><td style="color:#fff">$56</td><td><input class="qty" data-id="grilled_steak" data-price="56" type="number" min="0" value="0" aria-label="Grilled Steak quantity"></td></tr>
            <tr><td style="color:#fff">Grilled Chicken</td><td style="color:#fff">$44</td><td><input class="qty" data-id="grilled_chicken" data-price="44" type="number" min="0" value="0" aria-label="Grilled Chicken quantity"></td></tr>
            <tr><td style="color:#fff">Sushi</td><td style="color:#fff">$35</td><td><input class="qty" data-id="sushi" data-price="35" type="number" min="0" value="0" aria-label="Sushi quantity"></td></tr>
            <tr><td style="color:#fff">S'More</td><td style="color:#fff">$48</td><td><input class="qty" data-id="smore" data-price="48" type="number" min="0" value="0" aria-label="S'More quantity"></td></tr>
          </tbody>
        </table>
      </div>

  <div id="statusBar" style="margin-top:10px;min-height:22px"></div>

      <!-- Action bar inside the card -->
      <div id="cashierActions" class="cashier-actions">
        <button id="doneBtn" type="button">Checkout</button>
        <button id="seedBtn" type="button" style="background:#444;color:#fff;padding:10px;border-radius:8px">Seed Inventory</button>
        <button id="clearBtn" type="button">Clear</button>
        <div style="flex:1"></div>
        <div id="total" style="font-weight:800;color:#fff;align-self:center"></div>
      </div>
    </div>
  </main>

  <script type="module">
    // simple guard
    if(!localStorage.getItem('loggedInUser')){ window.location.href = 'admin.html'; }

    // Webhooks
    const lowWebhook = 'https://discord.com/api/webhooks/1138767072194073658/0CqFOr9mKqg5Gq3W3mqt3u4N3m3bqfG9k3h0Zb1xYjK2pQx8G5Y7h2xLw9aR5tU1v';
  const receiptWebhook = 'https://discord.com/api/webhooks/1430913713015361666/j182WADG9VHKQWwme8O8KcVnZUQoc9Mc3hgQOTmmnURAats53GdS5TYOfoAmF8EKu66j';

    // recipes mapping: menu id -> array of ingredient names (duplicates mean multiple units)
    const recipes = {
      fried_bacon: ['Bacon'],
      mac_cheese: ['Cheese Block','Macaroni Noodles'],
      french_toast: ['Bread','Eggs','Milk'],
      pancakes: ['Bag of Flour','Milk','Eggs'],
      fried_egg: ['Eggs'],
      scrambled_eggs: ['Cheese Block','Milk','Eggs'],
      hot_cocoa: ['Chocolate Bar','Milk','Milk'],
      mashed_potatoes: ['Potatoes','Butter'],
      grilled_cheese: ['Bread','Cheese Block'],
      latke: ['Potatoes','Bag of Flour','Eggs','Butter'],
      tamales: ['Corn','Corn','Butter','Seasoning'],
      eggnog: ['Milk','Eggs','Pumpkin Spice'],
      gravy: ['Butter','Bag of Flour','Milk'],
      nachos: ['Tortilla Chips','Cheese Block'],
      choc_chip_cookies: ['Bag of Flour','Butter','Bag of Sugar','Eggs','Chocolate Bar'],
      pumpkin_pie: ['Bag of Flour','Butter','Bag of Sugar','Pumpkin','Pumpkin Spice'],
      christmas_cookie: ['Bag of Flour','Bag of Sugar','Milk','Butter','Eggs'],
      chocolate_cake: ['Bag of Flour','Bag of Sugar','Milk','Eggs','Chocolate Bar'],
      lasagna: ['Lasagna Noodles','Tomato Sauce','Cheese Block','Ground Beef'],
      pizza: ['Bag of Flour','Milk','Tomato Sauce','Cheese Block','Pepperoni'],
      stuffing: ['Bread','Butter','Eggs'],
      baked_potatoes: ['Potatoes','Cheese Block','Butter'],
      apple_pie: ['Bag of Flour','Butter','Bag of Sugar','Apple','Apple'],
      gingerbread_cookie: ['Bag of Flour','Bag of Sugar','Pumpkin Spice','Butter'],
      pecan_pie: ['Bag of Flour','Butter','Bag of Sugar','Nuts'],
      cooked_turkey: ['Turkey','Butter','Seasoning'],
      dinner_rolls: ['Bread','Bread','Milk','Eggs'],
      candied_yams: ['Potatoes','Potatoes','Bag of Sugar'],
      hamburger: ['Cheese Block','Hamburger Patties','Hamburger Buns'],
      kebabs: ['Pineapple','Steak','Bell Pepper'],
      grilled_steak: ['Steak','Seasoning'],
      grilled_chicken: ['Chicken','Seasoning'],
      sushi: ['Rice','Fish'],
      smore: ['Graham Crackers','Chocolate Bar','Marshmallows']
    };

    function normalizeKey(name){ return name.toString().toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,''); }

    // dynamic firebase helper
    let _firebaseApp = null;
    let _db = null;
    async function ensureDb(){
      if(_db) return { db:_db, funcs: null };
      try{
        const modApp = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js');
        const modFs = await import('https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js');
        const { initializeApp } = modApp;
        const { getFirestore, doc, getDoc, setDoc, updateDoc } = modFs;
        if(!_firebaseApp){
          const firebaseConfig = {
            apiKey: "AIzaSyAK-baJsRLyBp8EFmtWFqOmjTxjALTRl6Q",
            authDomain: "hunter-s-2e810.firebaseapp.com",
            projectId: "hunter-s-2e810",
            storageBucket: "hunter-s-2e810.appspot.com",
            messagingSenderId: "897135124770",
            appId: "1:897135124770:web:7018fb47a4ec4d7c52857b"
          };
          _firebaseApp = initializeApp(firebaseConfig);
        }
        _db = getFirestore(_firebaseApp);
        return { db: _db, funcs: { doc, getDoc, setDoc, updateDoc } };
      }catch(e){ console.warn('Firebase dynamic import failed', e); return null }
    }

    async function sendWebhook(url, content){
      const statusEl = document.getElementById('statusBar');
      statusEl.textContent = 'Sending webhooks...';
      try{
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify({ content })
        });

        // If the response is opaque due to CORS it may still succeed but we can't inspect it.
        if(res.type === 'opaque'){
          statusEl.textContent = 'Webhook sent (opaque response)';
          console.debug('opaque response from webhook');
          return true;
        }

        const txt = await res.text().catch(()=>null);
        if(res.ok || res.status === 204){
          statusEl.textContent = 'Webhook sent (' + (res.status||'ok') + ')';
          console.debug('webhook response', res.status, txt);
          return true;
        }

        // If we reach here it's a non-OK HTTP status. Show details to help debug CORS/permission issues.
        statusEl.textContent = `Webhook failed: ${res.status} ${res.statusText}`;
        console.warn('webhook failed', res.status, res.statusText, txt);

        // try a no-cors fallback (may not allow content-type and may be blocked by the browser)
        try{
          await fetch(url, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ content }) });
          statusEl.textContent = 'Webhook attempted (no-cors fallback)';
          return true;
        }catch(fbErr){
          console.warn('no-cors fallback failed', fbErr);
        }

        return false;
      }catch(e){
        console.error('webhook error', e);
        statusEl.textContent = 'Webhook error: ' + (e && e.message ? e.message : String(e));
        return false;
      }
    }

    document.getElementById('doneBtn').addEventListener('click', async ()=>{
      const inputs = Array.from(document.querySelectorAll('.qty'));
      let total = 0; const receipt = []; const low = [];
      for(const inp of inputs){ const q = Number(inp.value||0); if(!q) continue; const id = inp.dataset.id; const price = Number(inp.dataset.price)||0; total += price*q; receipt.push({id,qty:q,price}); }
      document.getElementById('total').textContent = 'Total: $' + total.toFixed(2);

      const fb = await ensureDb();
      if(fb){
        // For each ordered recipe, decrement ingredient docs by qty * ingredient count
        for(const r of receipt){
          const recipe = recipes[r.id];
          if(!recipe) continue;
          // build ingredient counts for this recipe
          const counts = {};
          for(const ing of recipe){ const k = normalizeKey(ing); counts[k] = (counts[k]||0) + 1 }
          // apply counts multiplied by servings (r.qty)
          for(const [k,c] of Object.entries(counts)){
            const delta = c * r.qty;
            try{
              const dref = fb.funcs.doc(fb.db, 'inventory', k);
              const snap = await fb.funcs.getDoc(dref);
              let cur = snap && snap.exists ? (snap.data().stock||0) : null;
              if(cur === null) cur = 100;
              const newVal = Math.max(0, cur - delta);
              try{ await fb.funcs.updateDoc(dref, { stock: newVal }); }catch(e){ await fb.funcs.setDoc(dref, { stock: newVal }); }
              if(newVal <= 20) low.push({id:k,stock:newVal});
            }catch(e){ console.warn('ingredient update failed', k, e); }
          }
        }
      }

  if(low.length) await sendWebhook(lowWebhook, `:warning: Low inventory: ${low.map(i=>i.id+"("+i.stock+")").join(', ')}`);

      if(receipt.length){
        const menuLookup = id => { const el = document.querySelector(`.qty[data-id="${id}"]`); if(!el) return id; const tr = el.closest('tr'); return tr ? tr.querySelector('td').textContent.trim() : id };
        const txt = `Receipt - ${new Date().toLocaleString()}\n` + receipt.map(r=>`${menuLookup(r.id)} x${r.qty} - $${(r.price*r.qty).toFixed(2)}`).join('\n') + `\nTotal: $${total.toFixed(2)}`;
        const ok = await sendWebhook(receiptWebhook, txt);
        if(!ok) console.warn('Receipt webhook may not have been delivered (check console)');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{ document.querySelectorAll('.qty').forEach(i=>i.value=0); document.getElementById('total').textContent = ''; });

    // seed inventory button: writes each ingredient doc with default stock 100
    document.getElementById('seedBtn').addEventListener('click', async ()=>{
      const fb = await ensureDb();
      if(!fb){ alert('Failed to initialize Firebase.'); return }
      const allIngredients = new Set();
      Object.values(recipes).forEach(arr=>arr.forEach(i=>allIngredients.add(i)));
      const ops = [];
      for(const ing of allIngredients){ const k = normalizeKey(ing); const dref = fb.funcs.doc(fb.db, 'inventory', k); ops.push((async ()=>{ try{ await fb.funcs.setDoc(dref, { stock: 100 }); }catch(e){ console.warn('seed failed',k,e) } })()); }
      await Promise.all(ops);
      alert('Seeded inventory with ' + allIngredients.size + ' items (stock=100).');
    });
  </script>
</body>
</html>